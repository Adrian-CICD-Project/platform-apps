# ============================================================================
# ClusterSecretStore - Azure Key Vault connection
# ============================================================================
# Prerequisites:
#   1. External Secrets Operator installed (via app-of-apps)
#   2. Azure Key Vault created (via Terraform module key-vault)
#   3. AKS kubelet identity has "Key Vault Secrets User" role on the vault
#
# Apply AFTER External Secrets Operator is running:
#   kubectl apply -f bootstrap/external-secrets-config.yaml
# ============================================================================
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: azure-key-vault
spec:
  provider:
    azurekv:
      authType: ManagedIdentity
      vaultUrl: "https://kv-devops-poc01-adrian.vault.azure.net/"
---
# ============================================================================
# ExternalSecret - ArgoCD GitHub App credentials (platform-apps)
# ============================================================================
# Expects the following secrets in Azure Key Vault:
#   - github-app-id
#   - github-app-installation-id
#   - github-app-private-key
# ============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: repo-platform-apps
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: ClusterSecretStore
  target:
    name: repo-platform-apps
    labels:
      argocd.argoproj.io/secret-type: repository
  data:
    - secretKey: url
      remoteRef:
        conversionStrategy: Default
        key: github-app-repo-url-platform-apps
    - secretKey: type
      remoteRef:
        conversionStrategy: Default
        key: github-app-repo-type
    - secretKey: project
      remoteRef:
        conversionStrategy: Default
        key: github-app-project
    - secretKey: githubAppID
      remoteRef:
        key: github-app-id
    - secretKey: githubAppInstallationID
      remoteRef:
        key: github-app-installation-id
    - secretKey: githubAppPrivateKey
      remoteRef:
        key: github-app-private-key
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: repo-infrastructure-env-dev
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: ClusterSecretStore
  target:
    name: repo-infrastructure-env-dev
    labels:
      argocd.argoproj.io/secret-type: repository
  data:
    - secretKey: url
      remoteRef:
        key: github-app-repo-url-env-dev
    - secretKey: type
      remoteRef:
        key: github-app-repo-type
    - secretKey: project
      remoteRef:
        key: github-app-project
    - secretKey: githubAppID
      remoteRef:
        key: github-app-id
    - secretKey: githubAppInstallationID
      remoteRef:
        key: github-app-installation-id
    - secretKey: githubAppPrivateKey
      remoteRef:
        key: github-app-private-key
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: repo-infrastructure-env-test
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: ClusterSecretStore
  target:
    name: repo-infrastructure-env-test
    labels:
      argocd.argoproj.io/secret-type: repository
  data:
    - secretKey: url
      remoteRef:
        key: github-app-repo-url-env-test
    - secretKey: type
      remoteRef:
        key: github-app-repo-type
    - secretKey: project
      remoteRef:
        key: github-app-project
    - secretKey: githubAppID
      remoteRef:
        key: github-app-id
    - secretKey: githubAppInstallationID
      remoteRef:
        key: github-app-installation-id
    - secretKey: githubAppPrivateKey
      remoteRef:
        key: github-app-private-key
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: repo-infrastructure-env-prod
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: ClusterSecretStore
  target:
    name: repo-infrastructure-env-prod
    labels:
      argocd.argoproj.io/secret-type: repository
  data:
    - secretKey: url
      remoteRef:
        key: github-app-repo-url-env-prod
    - secretKey: type
      remoteRef:
        key: github-app-repo-type
    - secretKey: project
      remoteRef:
        key: github-app-project
    - secretKey: githubAppID
      remoteRef:
        key: github-app-id
    - secretKey: githubAppInstallationID
      remoteRef:
        key: github-app-installation-id
    - secretKey: githubAppPrivateKey
      remoteRef:
        key: github-app-private-key
